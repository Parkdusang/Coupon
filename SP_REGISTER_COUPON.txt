CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_REGISTER_COUPON`(
IN IN_TITLE VARCHAR(100),
IN IN_THUMBNAIL VARCHAR(70),
IN IN_START_TIME TIMESTAMP,
IN IN_END_TIME TIMESTAMP,
IN IN_COUPON_PREFIX VARCHAR(10)
)
BEGIN
	DECLARE RESULT INT;
    DECLARE MAX_COUPON_SEQ INT;
	DECLARE VAL_TABLE_NAME VARCHAR(50);


    DECLARE exit handler for SQLEXCEPTION
	  BEGIN
		ROLLBACK;
		SET RESULT = CONCAT('UPDATE tb_coupon_code_',IN_COUPON_SEQ);
        SELECT -1;
		END;

    START TRANSACTION;
		SELECT MAX(COUPON_SEQ) INTO MAX_COUPON_SEQ FROM tb_coupon_info;
		IF MAX_COUPON_SEQ IS NULL THEN
			SET MAX_COUPON_SEQ = 0;
		END IF;

		SET MAX_COUPON_SEQ = MAX_COUPON_SEQ + 1;

		SET VAL_TABLE_NAME = CONCAT('tb_coupon_code_',MAX_COUPON_SEQ);


		IF  (SELECT COUNT(1) FROM information_schema.tables WHERE table_name = VAL_TABLE_NAME) = 0 THEN

			SET @sqlStr = CONCAT('CREATE TABLE ',VAL_TABLE_NAME,' ');
			SET @sqlStr = CONCAT(@sqlStr,'(SEQ int NOT NULL AUTO_INCREMENT,');
			SET @sqlStr = CONCAT(@sqlStr,'COUPON_SEQ mediumint DEFAULT NULL,');
			SET @sqlStr = CONCAT(@sqlStr,'COUPON_CODE varchar(20) DEFAULT NULL,');
			SET @sqlStr = CONCAT(@sqlStr,'TARGET_USER_ID varchar(70) DEFAULT NULL,');
			SET @sqlStr = CONCAT(@sqlStr,'IS_USED varchar(1) DEFAULT \'N\' , ');
			SET @sqlStr = CONCAT(@sqlStr,'REG_DATE timestamp DEFAULT CURRENT_TIMESTAMP,');
			SET @sqlStr = CONCAT(@sqlStr,'MOD_DATE timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,');
			SET @sqlStr = CONCAT(@sqlStr,'PRIMARY KEY (SEQ)) ENGINE=InnoDB AUTO_INCREMENT=0');

			PREPARE stmt FROM @sqlStr;
			EXECUTE stmt;

			INSERT INTO tb_coupon_info (COUPON_SEQ,TITLE,THUMBNAIL,START_DATE,END_DATE) VALUES (MAX_COUPON_SEQ,IN_TITLE,IN_THUMBNAIL,IN_START_TIME,IN_END_TIME);
			INSERT INTO tb_coupon_prefix (COUPON_SEQ, COUPON_PREFIX) VALUES ( MAX_COUPON_SEQ, IN_COUPON_PREFIX);
			INSERT INTO tb_coupon_count (COUPON_SEQ) VALUES (MAX_COUPON_SEQ);

			SET RESULT = MAX_COUPON_SEQ;

		ELSE
			SET RESULT = -1;
		END IF;
	COMMIT;
	SELECT RESULT;
END
